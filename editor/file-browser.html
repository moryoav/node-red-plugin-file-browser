<script type="text/javascript">
(function() {
  // Monaco loader (with textarea fallback)
  function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement("script");s.src=src;s.onload=res;s.onerror=()=>rej(new Error("load fail "+src));document.head.appendChild(s);});}
  const MonacoReady=(function(){let p=null;return function(){if(p)return p;p=new Promise(async(res,rej)=>{if(window.monaco&&window.monaco.editor)return res(window.monaco);if(!window.require){try{await loadScript("https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/loader.min.js");}catch(e){return rej(e);}}try{window.require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs"}});window.require(["vs/editor/editor.main"],()=>window.monaco&&window.monaco.editor?res(window.monaco):rej(new Error("monaco init failed")));}catch(e){rej(e);}});return p;};})();

  // Simple ajax (relative URLs)
  function ajax(method, url, data) {
    return $.ajax({ method, url, data: data ? JSON.stringify(data) : undefined, contentType: data ? "application/json" : undefined });
  }

  RED.plugins.registerPlugin("file-browser", {
    onadd: function() {
      const $root   = $("<div>").css({position:"relative", height:"100%", display:"flex", gap:"8px"});

      // Left panel (tree + base controls)
      const $left   = $("<div>").css({width:"38%", minWidth:"280px", height:"100%", display:"flex", flexDirection:"column", borderRight:"1px solid var(--red-ui-secondary-background)"});
      const $leftHdr= $("<div>").css({padding:"8px", display:"grid", gridTemplateColumns:"1fr auto auto", gap:"6px", alignItems:"center", borderBottom:"1px solid var(--red-ui-secondary-background)"});
      const $baseLabel = $('<span style="font-size:0.8em;opacity:0.8;white-space:nowrap;align-self:center;">Base:</span>');
      const $baseInput = $('<input type="text" readonly>').css({gridColumn:"1 / span 1", width:"100%", fontSize:"0.85em", padding:"4px 6px"});
      const $btnChangeBase= $('<button class="red-ui-button" title="Change baseâ€¦"><i class="fa fa-folder-open"></i></button>').css({justifySelf:"end"});
      const $btnRefreshL  = $('<button class="red-ui-button" title="Refresh"><i class="fa fa-refresh"></i></button>');
      const $treeWrap= $("<div>").css({flex:"1 1 auto", overflow:"auto"});
      const $tree   = $("<div>").attr("id","fb-tree").css({padding:"6px"});

      $leftHdr.append($baseLabel, $baseInput, $btnChangeBase, $btnRefreshL);
      $treeWrap.append($tree);
      $left.append($leftHdr, $treeWrap);

      // Right panel (editor + ops)
      const $right  = $("<div>").css({flex:"1 1 auto", height:"100%", display:"flex", flexDirection:"column"});
      const $toolbar= $("<div>").css({padding:"6px", display:"flex", gap:"6px", alignItems:"center", borderBottom:"1px solid var(--red-ui-secondary-background)"});
      const $crumb  = $("<div>").css({fontSize:"0.85em", opacity:0.8, flex:"1 1 auto", overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"});
      const $btnNewFile = $('<button class="red-ui-button"><i class="fa fa-file-o"></i> New file</button>');
      const $btnNewDir  = $('<button class="red-ui-button"><i class="fa fa-folder-o"></i> New folder</button>');
      // Save: gray/disabled by default; becomes red only when there are unsaved edits
      const $btnSave    = $('<button class="red-ui-button"><i class="fa fa-save"></i> Save</button>').prop("disabled", true);
      const $editorHost = $("<div>").attr("id","fb-editor").css({flex:"1 1 auto", position:"relative", minHeight:"220px"});
      const $status     = $("<div>").css({padding:"4px 8px", borderTop:"1px solid var(--red-ui-secondary-background)", fontSize:"0.85em", opacity:0.8});

      $toolbar.append($crumb, $btnNewFile, $btnNewDir, $btnSave);
      $right.append($toolbar, $editorHost, $status);
      $root.append($left, $right);

      // State
      let baseInfo = { baseDir:"", userDir:"" };
      let currentDir = ".";
      let currentFile = null;
      let monacoEditor = null, textarea = null, editorKind = "none";
      let dirty = false;

      // Track on-disk state of current file (mtime/size)
      let lastDisk = { mtime: null, size: null };
      let statTimer = null;
      let onDiskChanged = false;

      function setStatus(t){ $status.text(t||""); }
      function notifyErr(x){ RED.notify(x,"error"); }

      function setCrumb(parts) {
        const segs = [];
        const acc = [];
        segs.push($('<a href="#">.</a>').on('click', (e)=>{ e.preventDefault(); loadList("."); }));
        (parts||[]).forEach((p)=>{
          acc.push(p);
          segs.push($('<span>/</span>'));
          segs.push($('<a href="#"></a>').text(p).on('click', (e)=>{ e.preventDefault(); loadList(acc.join("/")); }));
        });
        $crumb.empty().append(segs);
      }

      function iconFor(it){ return $('<i class="fa"></i>').addClass(it.type==="dir"?"fa-folder":"fa-file-text-o").css({width:"16px",marginRight:"6px"}); }
      function rowUp(){
        const $r=$('<div class="fb-row">').css({display:"flex",alignItems:"center",padding:"4px 2px",cursor:"pointer"});
        $r.append($('<i class="fa fa-level-up"></i>').css({width:"16px",marginRight:"6px"}), $('<span>').text(".."));
        $r.on('click', ()=>{ const parent = currentDir.split("/").filter(Boolean).slice(0,-1).join("/") || "."; loadList(parent); });
        return $r;
      }

      function renderTree(list){
        baseInfo.baseDir = list.baseDir || baseInfo.baseDir;
        baseInfo.userDir = list.userDir || baseInfo.userDir;
        $baseInput.val(baseInfo.baseDir || "");

        currentDir = list.cwd;
        setCrumb(list.breadcrumb);
        $tree.empty();
        const rows=[];
        if (list.cwd!==".") rows.push(rowUp());
        list.items.forEach((it)=>{
          const $r=$('<div class="fb-row">').css({display:"flex",alignItems:"center",padding:"4px 2px",cursor:"pointer"});
          $r.append(iconFor(it), $('<span>').text(it.name).css({flex:"1 1 auto"}));
          $r.on('click', ()=>{ it.type==="dir" ? loadList(it.path) : openFile(it.path); });
          rows.push($r);
        });
        rows.forEach(r=>$tree.append(r));
      }

      function loadConfigThenList() {
        ajax("GET", "filebrowser/config")
          .done((cfg)=>{ baseInfo = cfg || baseInfo; $baseInput.val(baseInfo.baseDir||""); loadList("."); })
          .fail(()=>{ loadList("."); });
      }

      // Save button appearance
      function updateSaveAppearance() {
        if (dirty) {
          // red, enabled
			$btnSave.prop("disabled", false).css({
			  backgroundColor: "#c9302c",   // a touch darker than #d9534f
			  color: "#ffffff",             // high-contrast text
			  borderColor: "#b52b27",
			  fontWeight: "600",
			  textShadow: "0 1px 0 rgba(0,0,0,0.35)"
			});
        } else {
          // gray, disabled
			$btnSave.prop("disabled", true).css({
			  backgroundColor: "",
			  color: "",
			  borderColor: "",
			  fontWeight: "",
			  textShadow: ""
			});
        }
      }
      function markDirty(val) {
        dirty = !!val;
        updateSaveAppearance();
      }

      function stopStatTimer(){ if (statTimer){ clearInterval(statTimer); statTimer=null; } }
      function startStatTimer(){
        stopStatTimer();
        if (!currentFile) return;
        statTimer = setInterval(statCurrent, 5000); // check every 5s
      }
      function statCurrent() {
        if (!currentFile) return;
        ajax("GET", "filebrowser/stat?path="+encodeURIComponent(currentFile))
          .done(res=>{
            const changed = (lastDisk.mtime !== null && (res.mtime !== lastDisk.mtime || res.size !== lastDisk.size));
            onDiskChanged = !!changed;
            if (onDiskChanged) setStatus("Opened: "+currentFile+" (changed on disk)");
            else setStatus("Opened: "+currentFile);
            updateSaveAppearance();
          })
          .fail(()=>{ /* ignore */ });
      }

      function loadList(dir) {
        ajax("GET", "filebrowser/list?path="+encodeURIComponent(dir))
          .done((res)=>{ renderTree(res); setStatus("Listed: "+res.cwd); })
          .fail((xhr)=>{ console.error("[file-browser] list error", xhr.status, xhr.responseText); notifyErr("List error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)); });
      }

      function ensureEditorReady(){
        if (editorKind==="monaco" && monacoEditor) return Promise.resolve("monaco");
        if (editorKind==="textarea" && textarea)   return Promise.resolve("textarea");
        return MonacoReady().then(()=>{
          monacoEditor = window.monaco.editor.create($editorHost[0], { value:"", language:"plaintext", automaticLayout:true, minimap:{enabled:false} });
          monacoEditor.onDidChangeModelContent(()=>{ if (currentFile){ markDirty(true);} });
          editorKind="monaco"; return "monaco";
        }).catch(()=>{
          textarea = $("<textarea>").css({position:"absolute", inset:"0", width:"100%", height:"100%", fontFamily:"monospace", fontSize:"12px", padding:"8px", boxSizing:"border-box"});
          $editorHost.empty().append(textarea);
          textarea.on("input", ()=>{ if (currentFile){ markDirty(true);} });
          editorKind="textarea"; return "textarea";
        });
      }
      function langFromFilename(name){
        const ext=(name.split(".").pop()||"").toLowerCase();
        const map={js:"javascript",ts:"typescript",py:"python",json:"json",md:"markdown",html:"html",css:"css",yml:"yaml",yaml:"yaml",sh:"shell",bat:"bat",
                   c:"c",cpp:"cpp",h:"cpp",hpp:"cpp",java:"java",cs:"csharp",rs:"rust",go:"go",sql:"sql",xml:"xml",ini:"ini",toml:"toml",txt:"plaintext"};
        return map[ext] || "plaintext";
      }
      function setEditorContent(text, filename){
        if (editorKind==="monaco" && monacoEditor){
          const lang=langFromFilename(filename||"");
          const model=window.monaco.editor.createModel(text, lang);
          monacoEditor.setModel(model);
        } else if (editorKind==="textarea" && textarea){ textarea.val(text); }
      }
      function getEditorContent(){ if (editorKind==="monaco" && monacoEditor) return monacoEditor.getValue(); if (editorKind==="textarea" && textarea) return textarea.val(); return ""; }

      function openFile(relPath) {
        ajax("GET", "filebrowser/open?path="+encodeURIComponent(relPath))
          .done((res)=>{
            ensureEditorReady().then(()=>{
              currentFile=relPath;
              lastDisk = { mtime: res.mtime || null, size: res.size || null };
              onDiskChanged = false;
              markDirty(false); // resets & updates save appearance
              setEditorContent(res.text||"", relPath);
              setStatus("Opened: "+relPath);
              startStatTimer();
            });
          })
          .fail((xhr)=>{ console.error("[file-browser] open error", xhr.status, xhr.responseText); notifyErr("Open error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)); });
      }

      function doSave(){
        if (!currentFile) return;
        const text = getEditorContent();
        ajax("POST","filebrowser/save",{ path: currentFile, text })
          .done((r)=>{
            lastDisk = { mtime: r.mtime || Date.now(), size: r.size || (text||"").length };
            onDiskChanged = false;
            markDirty(false);
            setStatus("Saved: "+currentFile);
            setTimeout(statCurrent, 500); // align with FS mtime soon after save
          })
          .fail((xhr)=>{ console.error("[file-browser] save error", xhr.status, xhr.responseText); notifyErr("Save error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)); });
      }

      // Left-panel controls
      $btnRefreshL.on("click", ()=> loadList(currentDir));
      $btnChangeBase.on("click", ()=>{
        const suggested = (baseInfo.baseDir?.replace(/\/+$/,'') || "")
                        + (currentDir && currentDir!=='.' ? '/'+currentDir : '');
        const abs = prompt(`Enter absolute base folder path inside userDir:\n(userDir: ${baseInfo.userDir})`,
                           suggested || baseInfo.baseDir || baseInfo.userDir || "");
        if (!abs) return;
        ajax("POST","filebrowser/set-base",{ path: abs })
          .done((cfg)=>{ baseInfo.baseDir = cfg.baseDir; $baseInput.val(baseInfo.baseDir); loadList("."); setStatus("Base set to: "+cfg.baseDir); })
          .fail((xhr)=> notifyErr("Set base error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)));
      });

      // Right-panel controls
      $btnSave.on("click", doSave);
      $btnNewFile.on("click", ()=>{
        const name = prompt("New file name:"); if (!name) return;
        ajax("POST","filebrowser/new-file",{ dir: currentDir, name })
          .done((res)=>{ loadList(currentDir); setStatus("Created file: "+res.path); })
          .fail((xhr)=> notifyErr("New file error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)));
      });
      $btnNewDir.on("click", ()=>{
        const name = prompt("New folder name:"); if (!name) return;
        ajax("POST","filebrowser/new-folder",{ dir: currentDir, name })
          .done((res)=>{ loadList(currentDir); setStatus("Created folder: "+res.path); })
          .fail((xhr)=> notifyErr("New folder error: "+(xhr.responseJSON?.error || xhr.statusText || xhr.status)));
      });

      RED.events.on("editor:close", ()=>{ if (dirty) RED.notify("Unsaved changes in "+(currentFile||"file"),"warning"); });

      RED.actions.add("file-browser:show", ()=> RED.sidebar.show("file-browser"));
      RED.sidebar.addTab({
        id:"file-browser", name:"Files", label:"Files", iconClass:"fa fa-files-o",
        content:$root, action:"file-browser:show", enableOnEdit:true, toolbar:null,
        onshow: function(){ if (!$tree.children().length) loadConfigThenList(); }
      });

      setTimeout(()=>{ if (!$tree.children().length) loadConfigThenList(); }, 0);
    }
  });
})();
</script>
